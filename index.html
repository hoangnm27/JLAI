<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Test Case Generator</title>
    <script>
        let threadId = null;  // LÆ°u thread_id Ä‘á»ƒ dÃ¹ng láº¡i
        const OPENAI_API_KEY = "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";
        const ASSISTANT_ID = "asst_cfoXdMTHow5kPmrYEtNtD2Hu";

        // ğŸ“Œ Táº¡o thread duy nháº¥t náº¿u chÆ°a cÃ³
        async function createThread() {
            try {
                const response = await fetch("https://api.openai.com/v1/threads", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${OPENAI_API_KEY}`,
                        "Content-Type": "application/json",
						"OpenAI-Beta": "assistants=v2"
                    }
                });

                const data = await response.json();
                if (data.id) {
                    threadId = data.id;
                    console.log("âœ… Thread ID:", threadId);
                } else {
                    console.error("âŒ Can not create the thread");
                }
            } catch (error) {
                console.error("âŒ Error of createThread", error);
            }
        }

        async function generateTestCase() {
            const prompt = document.getElementById("prompt").value;
            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = "â³ In Progress...";

            // ğŸ“Œ Náº¿u chÆ°a cÃ³ thread, táº¡o thread trÆ°á»›c
            if (!threadId) {
                await createThread();
            }

            try {
                // ğŸ“Œ Gá»­i prompt vÃ o thread
                await fetch(`https://api.openai.com/v1/threads/${threadId}/messages`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${OPENAI_API_KEY}`,
                        "Content-Type": "application/json",
						"OpenAI-Beta": "assistants=v2"
                    },
                    body: JSON.stringify({ role: "user", content: prompt })
                });

                // ğŸ“Œ Cháº¡y thread Ä‘á»ƒ AI xá»­ lÃ½
                const runRes = await fetch(`https://api.openai.com/v1/threads/${threadId}/runs`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${OPENAI_API_KEY}`,
                        "Content-Type": "application/json",
						"OpenAI-Beta": "assistants=v2"
                    },
                    body: JSON.stringify({ assistant_id: ASSISTANT_ID })
                });

                const runData = await runRes.json();
                if (!runData.id) throw new Error("âŒ run_id NA");
                const runId = runData.id;
                console.log("âœ… Run ID:", runId);

                // ğŸ“Œ Chá» OpenAI xá»­ lÃ½
                let status = "";
                do {
                    await new Promise(resolve => setTimeout(resolve, 5000)); // Chá» 5s
                    const checkRes = await fetch(`https://api.openai.com/v1/threads/${threadId}/runs/${runId}`, {
                        method: "GET",
                        headers: { "Authorization": `Bearer ${OPENAI_API_KEY}`,
									"OpenAI-Beta": "assistants=v2"}
                    });

                    const checkData = await checkRes.json();
                    status = checkData.status;
                    console.log("ğŸ”„ Status:", status);
                } while (status !== "completed");

                // ğŸ“Œ Láº¥y táº¥t cáº£ messages tá»« thread
                const messageRes = await fetch(`https://api.openai.com/v1/threads/${threadId}/messages`, {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${OPENAI_API_KEY}`,
								"OpenAI-Beta": "assistants=v2"}
                });

                const messageData = await messageRes.json();
                console.log("ğŸ“Œ OpenAI Messages:", JSON.stringify(messageData, null, 2));

                if (!messageData.data || messageData.data.length === 0) throw new Error("âŒ No test case created");

                // âœ… Láº¥y message cÃ³ `run_id` trÃ¹ng vá»›i láº§n cháº¡y gáº§n nháº¥t
                const correctMessage = messageData.data.find(msg => msg.run_id === runId);

                if (!correctMessage) throw new Error("âŒ No message matched the run_id");

                // ğŸ“Œ Láº¥y test case tá»« message Ä‘Ãºng
                const extractedText = correctMessage.content
                    .map(item => item.text?.value || "")
                    .filter(text => text.trim() !== "")
                    .join("\n");

                console.log("âœ… Test Case:", extractedText);
                resultDiv.innerHTML = `<h3>âœ… Test Case:</h3><pre>${extractedText}</pre>`;

            } catch (error) {
                resultDiv.innerHTML = `<h3>âŒ Error:</h3> ${error.message}`;
            }
        }
    </script>
</head>
<body>
    <h1>AI Test Case Generator</h1>
    <textarea id="prompt" placeholder="Input Promt..."></textarea>
    <button onclick="generateTestCase()">Generate Test Cases</button>
    <h2>Output:</h2>
    <div id="result" style="white-space: pre-wrap; border: 1px solid #ddd; padding: 10px;"></div>
</body>
</html>
